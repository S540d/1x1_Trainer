name: Build Android AAB for Play Store

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      profile:
        description: 'Build profile (production/preview)'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo and EAS
        run: |
          npm install -g eas-cli
          eas --version

      - name: Run tests
        run: npm test

      - name: Build Android AAB with EAS
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build --platform android --profile ${{ github.event.inputs.profile }} --non-interactive --no-wait
          echo "âœ… EAS Build submitted successfully!"
          echo "Check build status at: https://expo.dev/accounts/devsven/projects/1x1-trainer/builds"

      - name: Build Info
        run: |
          echo "ðŸš€ Android Build submitted to EAS!"
          echo "Profile: ${{ github.event.inputs.profile }}"
          echo "Version: $(node -p "require('./package.json').version")"
          echo "VersionCode: $(node -p "require('./app.json').expo.android.versionCode")"
          echo ""
          echo "ðŸ“¦ Expected output:"
          if [ "${{ github.event.inputs.profile }}" = "production" ]; then
            echo "  - Android App Bundle (AAB) for Play Store"
          else
            echo "  - Android APK for testing"
          fi
          echo ""
          echo "Monitor build progress:"
          echo "https://expo.dev/accounts/devsven/projects/1x1-trainer/builds"

      - name: Create Release Note
        run: |
          cat > build-info.txt << EOF
          1x1 Trainer - Android Build
          ============================
          Version: $(node -p "require('./package.json').version")
          VersionCode: $(node -p "require('./app.json').expo.android.versionCode")
          Build Profile: ${{ github.event.inputs.profile }}
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit: ${{ github.sha }}

          Build submitted to Expo EAS.
          Check status: https://expo.dev/accounts/devsven/projects/1x1-trainer/builds

          Download the AAB/APK when ready from the EAS dashboard.
          EOF
          cat build-info.txt

      - name: Upload Build Info
        uses: actions/upload-artifact@v4
        with:
          name: build-info-${{ github.run_number }}
          path: build-info.txt
          retention-days: 90
